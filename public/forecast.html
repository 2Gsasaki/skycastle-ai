<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>å¤©ç©ºã®åŸè¶Šå‰å¤§é‡åŸã€€é›²æµ·äºˆå ±</title>
    <style>
      :root {
        color-scheme: light dark;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: #f7f7fa;
        color: #222;
      }
      body {
        margin: 0;
        padding: 0;
      }
      header {
        background: linear-gradient(135deg, #050608, #1a1d24);
        color: #fff;
        padding: 2rem 1.5rem 1.2rem;
        text-align: center;
      }
      header a {
        color: inherit;
        text-decoration: none;
      }
      header a:hover {
        text-decoration: underline;
      }
      header h1 {
        margin: 0 0 0.5rem;
        font-size: 1.8rem;
      }
      header h1 .title-sub {
        display: inline-block;
        margin-left: 0.4rem;
      }
      header p {
        margin: 0;
        opacity: 0.85;
      }
      header p .disclaimer {
        font-size: 0.75rem;
        display: inline-block;
        margin-top: 0.4rem;
        opacity: 0.75;
      }
      main {
        padding: 1.5rem;
        max-width: 1200px;
        margin: 0 auto;
      }
      .legend,
      .updated {
        margin-bottom: 1rem;
        font-size: 0.9rem;
      }
      .legend {
        font-size: 0.75rem;
        line-height: 1.4;
        margin-top: 0.8rem;
        margin-bottom: 0.6rem;
      }
      .legend + .legend {
        margin-top: 0.4rem;
      }
      .legend-text {
        font-size: inherit;
      }
      .updated {
        font-size: 0.75rem;
        text-align: right;
        color: rgba(33, 51, 92, 0.75);
      }
      .legend .legend-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 8.2em;
        background: #4caf50;
        color: #fff;
        padding: 0.2rem 0.6rem;
        border-radius: 999px;
        font-weight: 600;
        margin-right: 0.25rem;
        font-size: 0.75rem;
      }
      .legend-break {
        display: none;
      }
      .legend .legend-badge.fog {
        background: #607d8b;
      }
      .cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 1rem;
      }
      .card {
        background: #fff;
        border-radius: 16px;
        padding: 1.2rem;
        box-shadow: 0 6px 16px rgba(31, 59, 108, 0.12);
        display: flex;
        flex-direction: column;
        gap: 0.6rem;
        border: 1px solid rgba(20, 40, 80, 0.05);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }
      .card.castle {
        border: 2px solid rgba(249, 200, 80, 0.55);
        box-shadow: 0 10px 20px rgba(249, 200, 80, 0.2);
        background-image:
          linear-gradient(155deg, rgba(255, 248, 220, 0.92), rgba(255, 255, 255, 0.65)),
          linear-gradient(25deg, rgba(255, 227, 160, 0.45), rgba(255, 255, 255, 0));
      }
      .card.fogonly {
        border: 1px dashed rgba(96, 125, 139, 0.4);
        background-image: linear-gradient(150deg, rgba(96, 125, 139, 0.12), rgba(255, 255, 255, 0));
      }
      .card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 24px rgba(31, 59, 108, 0.18);
      }
      .card h2 {
        margin: 0;
        font-size: 1.2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .badge {
        padding: 0.2rem 0.6rem;
        border-radius: 999px;
        font-size: 0.75rem;
        color: #fff;
      }
      .badge.castle {
        background: #4caf50;
      }
      .badge.fog {
        background: #607d8b;
      }
      .badge.none {
        background: #9e9e9e;
      }
      .probability {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.2rem;
        text-align: center;
      }
      .probability .prob-label {
        font-size: 0.85rem;
        letter-spacing: 0.12em;
        color: rgba(33, 51, 92, 0.7);
        text-transform: uppercase;
      }
      .probability .prob-value {
        font-size: 2.6rem;
        font-weight: 700;
        line-height: 1.05;
        letter-spacing: 0.02em;
        text-shadow: 0 4px 12px rgba(31, 59, 108, 0.15);
      }
      .weather-chip {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        font-size: 0.95rem;
        padding: 0.35rem 0.7rem;
        border-radius: 999px;
        background: rgba(31, 59, 108, 0.08);
        color: rgba(33, 51, 92, 0.85);
        margin: 0.2rem auto 0.5rem;
      }
      .detail-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 0.3rem 0.6rem;
        font-size: 0.85rem;
      }
      .detail-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.45rem 0.6rem;
        border-radius: 10px;
        background: rgba(31, 59, 108, 0.06);
        font-weight: 600;
      }
      .detail-label {
        font-size: 0.78rem;
        color: rgba(33, 51, 92, 0.72);
        letter-spacing: 0.03em;
      }
      .detail-value {
        font-size: 0.95rem;
      }
      @media (max-width: 640px) {
        .detail-grid {
          grid-template-columns: 1fr;
        }
        .legend-break {
          display: block;
          height: 0;
          margin-bottom: 0.35rem;
        }
        .legend .legend-text {
          display: block;
          margin-top: 0.3rem;
          line-height: 1.6;
        }
        header h1 .title-sub {
          display: block;
          margin-left: 0;
          margin-top: 0.2rem;
        }
        .footer-line.secondary {
          display: block;
          margin-top: 0.3rem;
        }
      }
      .footer {
        margin-top: 2rem;
        font-size: 0.8rem;
        color: #607d8b;
        text-align: center;
      }
      .footer-line {
        display: inline;
      }
      .footer a {
        color: inherit;
        text-decoration: underline;
      }
      @media (prefers-color-scheme: dark) {
        :root {
          background: #111;
          color: #f1f1f1;
        }
        .card {
          background: #1e1f24;
          border-color: rgba(255, 255, 255, 0.06);
          box-shadow: 0 8px 18px rgba(0, 0, 0, 0.4);
        }
        .card.castle {
          background-image:
            linear-gradient(155deg, rgba(249, 200, 80, 0.2), rgba(30, 31, 36, 0.65)),
            linear-gradient(25deg, rgba(255, 227, 160, 0.18), rgba(30, 31, 36, 0));
          border-color: rgba(249, 200, 80, 0.7);
          box-shadow: 0 10px 22px rgba(249, 200, 80, 0.22);
        }
        .card.fogonly {
          background-image: linear-gradient(150deg, rgba(96, 125, 139, 0.2), rgba(30, 31, 36, 0.4));
          border-color: rgba(96, 125, 139, 0.6);
        }
        .probability .prob-label {
          color: rgba(255, 255, 255, 0.7);
        }
        .detail-item {
          background: rgba(255, 255, 255, 0.06);
          font-weight: 600;
        }
        .detail-label {
          color: rgba(255, 255, 255, 0.6);
        }
        .weather-chip {
          background: rgba(255, 255, 255, 0.12);
          color: rgba(255, 255, 255, 0.88);
        }
        header {
          background: linear-gradient(135deg, #020205, #17181c);
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1 class="title-heading">
        <a class="title-main" href="https://www.onocastle.net/" target="_blank" rel="noreferrer noopener"
          >å¤©ç©ºã®åŸè¶Šå‰å¤§é‡åŸ</a
        ><span class="title-sub">é›²æµ·äºˆå ±</span>
      </h1>
      <p>
        AIãŒæ°—è±¡æ¡ä»¶ã¨éå»ã®å‡ºç¾è¨˜éŒ²ã‹ã‚‰é›²æµ·ã«æµ®ã‹ã¶è¶Šå‰å¤§é‡åŸã®å‡ºç¾ç¢ºç‡ã‚’äºˆæ¸¬ã—ã¦ã„ã¾ã™ã€‚<br />
        <span class="disclaimer">ï¼ˆâ€»é›²æµ·äºˆå ±ã¯çµæœã‚’ä¿è¨¼ã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰</span>
      </p>
    </header>
    <main>
      <div class="legend">
        <span class="legend-badge">å¤©ç©ºã®åŸãƒãƒ£ãƒ³ã‚¹</span><br class="legend-break" />
        <span class="legend-text">
          æœ5æ™‚ã‹ã‚‰8æ™‚é ƒã«
          <a href="https://maps.app.goo.gl/5q2RKqJqBUggHkNe6" target="_blank" rel="noreferrer noopener">çŠ¬å±±åŸå€(æ¨™é«˜324m)</a>
          ã‹ã‚‰é›²æµ·ã«æµ®ã‹ã¶å§¿ã‚’è¦³è³ã§ãã‚‹ãƒãƒ£ãƒ³ã‚¹ï¼
          <a href="https://www.onocastle.net/skycastle/" target="_blank" rel="noreferrer noopener">è©³ã—ãã¯å¤©ç©ºã®åŸè¶Šå‰å¤§é‡åŸã‚µã‚¤ãƒˆã¸</a>
        </span>
      </div>
      <div class="legend">
        <span class="legend-badge fog">éœ§æµ·ã®äºˆæ„Ÿ</span><br class="legend-break" />
        <span class="legend-text">éœ§ã‚„é›²ãŒæ¿ƒãç«‹ã¡ã“ã‚ã¦é›°å›²æ°—ã¯æŠœç¾¤ã ã‘ã©ã€å¤©ç©ºã®åŸãŒè¦‹ãˆã‚‹ã‹ã¯é‹æ¬¡ç¬¬ã€‚</span>
      </div>
      <div class="updated" id="updated">æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...</div>
      <div class="cards" id="cards"></div>
      <div class="footer">
        <span class="footer-line primary">Â© 2025 <a href="https://www.2ndgate.jp/" target="_blank" rel="noreferrer noopener">ã‚»ã‚«ãƒ³ãƒ‰ã‚²ãƒ¼ãƒˆ</a></span>
        <span class="footer-line secondary">| Powered by Open-Meteo | æ¨è«–ãƒ¢ãƒ‡ãƒ«: SkyCastle AI</span><br />
        æœ¬äºˆå ±ã‚’åˆ©ç”¨ã—ã¦ç™ºç”Ÿã—ãŸãƒˆãƒ©ãƒ–ãƒ«ãƒ»æå®³ã«ã¤ã„ã¦ã€å½“æ–¹ã¯ä¸€åˆ‡è²¬ä»»ã‚’è² ã„ã‹ã­ã¾ã™ã€‚
      </div>
    </main>
    <script>
      const weatherLegend = [
        { codes: [0], icon: "â˜€ï¸", label: "å¿«æ™´" },
        { codes: [1, 2], icon: "ğŸŒ¤ï¸", label: "æ™´ã‚Œ" },
        { codes: [3], icon: "â˜ï¸", label: "æ›‡ã‚Š" },
        { codes: [45, 48], icon: "ğŸŒ«ï¸", label: "éœ§" },
        { codes: [51, 53, 55, 61, 63, 65, 66, 67, 80, 81, 82], icon: "ğŸŒ§ï¸", label: "é›¨" },
        { codes: [56, 57], icon: "ğŸŒ§ï¸", label: "æ°·é›¨" },
        { codes: [71, 73, 75, 77, 85, 86], icon: "â„ï¸", label: "é›ª" },
        { codes: [95, 96, 99], icon: "â›ˆï¸", label: "é›·é›¨" },
      ];

      function resolveWeatherInfo(code) {
        if (typeof code !== "number" || Number.isNaN(code)) return null;
        for (const entry of weatherLegend) {
          if (entry.codes.includes(code)) {
            return entry;
          }
        }
        return { icon: "ğŸŒ¤ï¸", label: "å¤©æ°—" };
      }

      function normalizeForecastPayload(payload) {
        if (Array.isArray(payload)) {
          return { predictions: payload, generatedAt: null };
        }
        if (payload && Array.isArray(payload.predictions)) {
          const generatedAt = payload.generated_at || payload.generatedAt || null;
          return { predictions: payload.predictions, generatedAt };
        }
        return { predictions: [], generatedAt: null };
      }

      function formatGeneratedTimestamp(isoString) {
        if (!isoString) return null;
        const parsed = new Date(isoString);
        if (Number.isNaN(parsed.getTime())) return null;
        return parsed.toLocaleString("ja-JP", { timeZone: "Asia/Tokyo" });
      }

      async function loadForecast() {
        const isFileProtocol = location.protocol === "file:";
        const updatedEl = document.getElementById("updated");
        const cardsEl = document.getElementById("cards");
        try {
          if (isFileProtocol) {
            throw new Error(
              "ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ¶é™ã«ã‚ˆã‚Šã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›´æ¥é–‹ãã¨ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã€‚ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ«ãƒ¼ãƒˆã§ `python3 -m http.server`ï¼ˆã¾ãŸã¯ç’°å¢ƒã«å¿œã˜ã¦ `python -m http.server`ï¼‰ã‚’å®Ÿè¡Œã—ã€http://localhost:8000/public/forecast.html ã‚’é–‹ã„ã¦ãã ã•ã„ã€‚"
            );
          }

          const response = await fetch("../data/forecast_predictions.json", { cache: "no-store" });
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          const data = await response.json();
          const { predictions, generatedAt } = normalizeForecastPayload(data);
          if (!Array.isArray(predictions) || predictions.length === 0) {
            updatedEl.textContent = "ãƒ‡ãƒ¼ã‚¿ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚fetch_forecast_window.py ã¨ predict_forecast_window.py ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚";
            return;
          }

          const sorted = [...predictions].sort(
            (a, b) => new Date(a.date).getTime() - new Date(b.date).getTime()
          );

          const formattedGeneratedAt = formatGeneratedTimestamp(generatedAt);
          if (formattedGeneratedAt) {
            updatedEl.textContent = `æœ€çµ‚æ›´æ–°ï¼ˆæ¨è«–ç”Ÿæˆï¼‰: ${formattedGeneratedAt}`;
          } else {
            const fallbackUpdatedAt = new Date().toLocaleString("ja-JP", { timeZone: "Asia/Tokyo" });
            updatedEl.textContent = `æœ€çµ‚æ›´æ–°: ${fallbackUpdatedAt}`;
          }

          cardsEl.innerHTML = "";
          sorted.forEach((item) => {
            const card = document.createElement("article");
            card.className = "card";

            const event = (item.event || "None").toLowerCase();
            const badgeClass = event === "castle" ? "castle" : event === "fogonly" ? "fog" : "none";
            const badgeLabel = event === "castle" ? "å¤©ç©ºã®åŸãƒãƒ£ãƒ³ã‚¹" : event === "fogonly" ? "éœ§æµ·ã®äºˆæ„Ÿ" : "";
            const weatherInfo = resolveWeatherInfo(item.weathercode);

            card.classList.add(event === "castle" ? "castle" : event === "fogonly" ? "fogonly" : "none");

            const detailRows = [
              { label: "é›²æµ·ç‡", value: formatPercent(item.fog_probability) },
              { label: "å¤©ç©ºç‡", value: formatPercent(item.castle_probability) },
              { label: "æ°—æ¸©", value: formatValue(item.temp, "â„ƒ") },
              { label: "æ¹¿åº¦", value: formatValue(item.humidity, "%") },
              { label: "é›²é‡", value: formatValue(item.cloud, "%") },
              { label: "é¢¨é€Ÿ", value: formatValue(item.wind, "m/s") },
              { label: "é™æ°´é‡", value: formatValue(item.rain, "mm") },
            ];

            card.innerHTML = `
              <h2>
                <span>${formatDate(item.date)}</span>
                ${badgeLabel ? `<span class="badge ${badgeClass}">${badgeLabel}</span>` : ""}
              </h2>
              ${weatherInfo ? `<div class="weather-chip">${weatherInfo.icon}<span>${weatherInfo.label}</span></div>` : ""}
              <div class="probability">
                <span class="prob-label">å¤©ç©ºã®åŸå‡ºç¾ç‡</span>
                <span class="prob-value">${formatPercent(item.castle_event_probability)}</span>
              </div>
              <div class="detail-grid">
                ${detailRows
                  .map(
                    (detail) => `
                      <div class="detail-item">
                        <span class="detail-label">${detail.label}</span>
                        <span class="detail-value">${detail.value}</span>
                      </div>
                    `
                  )
                  .join("")}
              </div>
            `;
            cardsEl.appendChild(card);
          });
        } catch (err) {
          updatedEl.textContent = `ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${err.message}`;
          cardsEl.innerHTML = "";
        }
      }

      function formatPercent(value) {
        if (typeof value !== "number" || Number.isNaN(value)) return "-";
        return `${Math.round(value * 100)}%`;
      }

      function formatValue(value, suffix = "") {
        if (typeof value !== "number" || Number.isNaN(value)) return "-";
        return `${value.toFixed(1)}${suffix}`;
      }

      function formatDate(dateStr) {
        const date = new Date(dateStr);
        if (Number.isNaN(date.getTime())) return dateStr;
        const weekday = "æ—¥æœˆç«æ°´æœ¨é‡‘åœŸ"[date.getDay()];
        return `${date.getMonth() + 1}/${date.getDate()}(${weekday})`;
      }

      loadForecast();
    </script>
  </body>
</html>
