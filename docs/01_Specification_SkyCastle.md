# 🏯 SkyCastle AI ― 越前大野・天空の城出現予測プロジェクト  
## 要件定義書（仕様書）

---

## 1. プロジェクト概要

**プロジェクト名：**  
SkyCastle AI（スカイキャッスルAI）

**目的：**  
福井県大野市における「天空の城（越前大野城）」出現条件をAI技術で解析・予測し、  
観光情報発信・撮影支援・地域ブランディングに活用する。

**コンセプト：**  
> 「名水の城下町 × AI × 雲海予報」  
> 科学的根拠に基づく“天空の城出現予報システム”を構築し、  
> 観光・地域DX・教育の分野で活用可能なオープンデータモデルを実現する。

---

## 2. システム目的と効果

| 目的 | 詳細 | 期待効果 |
|------|------|----------|
| ① 天空の城出現予測 | 気象データ（気温・湿度・風・雲量・降水）をもとにAIで確率を算出 | 観光客・写真家向けに「出現チャンス日」を提供 |
| ② 手動確認 | ダッシュボードで最新予報を確認 | 夜間・早朝観測準備を支援 |
| ③ 可視化・オープンデータ化 | ダッシュボードで公開、JSONフィードで他サイトに提供 | 地域・メディア・教育機関での利活用促進 |
| ④ 画像解析による検証 | ライブカメラ映像から「霧の実際」を判定 | AI予測の信頼性を向上 |

---

## 3. 対象地域・データ範囲

| 項目 | 内容 |
|------|------|
| 対象エリア | 福井県大野市（越前大野城周辺） |
| 緯度経度 | 緯度 35.98 ／ 経度 136.49 |
| 予測対象時間帯 | 翌朝 5:00〜8:00 |
| データ期間 | 過去1〜3年の気象データ（学習用）＋最新予報（推論用） |

---

## 4. 機能要件

### 4.1 データ取得機能
- Open-Meteo API より気象データ（気温・湿度・風速・雲量・降水量）を自動取得  
- 対象時間帯：翌朝5〜8時の4時間分を取得し平均値・派生指標を算出  
- 更新頻度：営業日の16:00に1回（Dockerコンテナ内スケジューラで実行）

### 4.2 AI推論機能
- LightGBM モデルによる「霧発生確率」と「天空の城成立確率」の二段推論  
- 入力：気温・湿度・風速・雲量・降水量、過去実績  
- 出力：`fog_probability`（0.0〜1.0）、`castle_probability`（0.0〜1.0）およびイベント判定（`FogOnly` / `Castle` / `None`）

### 4.3 スコア算出機能（ルールベース）
- 露点温度（Td）を算出  
- 露点差（T − Td）・風速・雲量・降水量を加味して霧スコア／城成立スコア（各0〜100点）を算出

### 4.4 結果出力
- `data/feed.json` に最新の霧発生確率・天空の城成立確率・イベント判定を保存  
- `data/history.csv` に日次履歴（霧観測・城成立の実績を含む）を蓄積（再学習用）

### 4.5 Webダッシュボード表示
- Streamlit による簡易UI  
- 表示内容：
  - 霧発生確率・天空の城成立確率（メーター表示）
  - 霧検出結果（画像）※画像解析導入時に表示
  - 過去7日間の霧／城確率推移グラフ
  - 最新の観測ログ一覧・未入力日の簡易アラート
- 「天気データを再取得」ボタンで即時に気象データ取得〜推論を手動実行
- 公開用URL例：`http://localhost:8501` または cloud上（Render/AWS EC2）にデプロイ

### 4.6 観測ログ入力機能
- ダッシュボード内に管理者向け簡易フォームを配置（ページ遷移なし）
- 入力項目：日付・霧発生有無・天空の城可視性・メモ
- 「保存」ボタンで `data/history.csv` に追記し、その場でリストを再表示
- `st.data_editor` 等を用いた過去データのインライン編集に対応

---

## 5. 非機能要件

| 項目 | 要件 |
|------|------|
| 開発言語 | Python 3.11以上 |
| 利用API | Open-Meteo API（無料・商用利用可） |
| AIモデル | LightGBM／Scikit-learn（無料・BSDライセンス） |
| 画像処理 | OpenCV＋CNN（Keras or PyTorch） |
| 通知 | なし（ダッシュボード閲覧で確認） |
| 表示 | Streamlit（無料・MITライセンス） |
| データ保存 | CSV／SQLite（ローカルDB） |
| 動作環境 | ローカルPC／Docker／クラウド（Render, AWS, GCP） |
| 自動実行 | Dockerコンテナ内スケジューラ（営業日16:00実行）／ローカル手動実行 |

---

## 6. 入出力定義

| 項目 | 形式 | 説明 |
|------|------|------|
| 入力データ | JSON（Open-Meteo API） | 気温・湿度・風速・雲量・降水 |
| 学習データ | CSV | 過去天気＋霧観測フラグ＋天空の城成立フラグ |
| 出力ファイル① | `feed.json` | 最新予測結果（霧確率・城確率・イベント判定） |
| 出力ファイル② | `history.csv` | 日次履歴（霧／城実績・メモを含む、再学習用） |
| 出力ファイル③ | `skycastle_fog.pkl`／`skycastle_castle.pkl` | 学習済みAIモデル（霧／城） |
| 出力ファイル④ | `fog_result.json` | カメラ解析結果（霧／城判定） |

---

## 7. 処理フロー概要

┌────────────────────────┐
│ ① Open-Meteo APIから気象データ取得 │
└──────┬────────────────────┘
↓
┌────────────────────────┐
│ ② 露点温度・露点差・スコア計算 │
└──────┬────────────────────┘
↓
┌────────────────────────┐
│ ③ LightGBMで霧発生確率を算出 │
└──────┬────────────────────┘
↓
┌────────────────────────┐
│ ④ LightGBMで天空の城成立確率を算出 │
└──────┬────────────────────┘
↓
┌────────────────────────┐
│ ⑤ JSON出力・履歴保存 │
└──────┬────────────────────┘
↓
┌────────────────────────┐
│ ⑥ 条件別メール通知 │
└──────┬────────────────────┘
↓
┌────────────────────────┐
│ ⑦ Streamlitで可視化 │
└────────────────────────┘

## 8. 運用要件

| 項目 | 内容 |
|------|------|
| 実行頻度 | 営業日16:00に自動予報実行（翌朝向け） |
| 自動化手段 | Dockerコンテナ起動時の常駐スケジューラ／手動実行（`docker compose run --rm dashboard python main.py`） |
| 通知方法 | ダッシュボード確認（メール通知は将来拡張） |
| 保守運用 | モデル更新（月1回）／ログ監視／バックアップ（`data/`・`model/`） |
| 共有 | JSONフィードを外部サイトに埋め込み可（iframe対応） |

---

## 9. 成果物一覧

| 種別 | ファイル名 | 概要 |
|------|-------------|------|
| ソースコード | `main.py` | 全体統括スクリプト |
| AIモデル | `model/skycastle_fog.pkl`／`model/skycastle_castle.pkl` | 霧発生モデルと天空の城成立モデル |
| 付随スクリプト | `scheduler.py` | 自動実行スケジューラ |
| 設定ファイル | `.env` | 将来の通知設定（現状未使用） |
| 出力データ | `data/feed.json`／`data/history.csv` | 予測結果と履歴 |
| 表示アプリ | `dashboard.py` | Streamlitダッシュボード（手動更新＋観測入力） |
| 画像解析 | `vision_fogdetector.py` | 霧判定AI（将来拡張） |

---

## 10. 将来的な拡張計画

| 項目 | 内容 |
|------|------|
| API提供 | REST API＋JSONフィードで外部提供 |
| メール／SNS通知 | 預測結果を自動配信（メール・X等） |
| カメラ統合 | ライブ映像からリアルタイム解析 |
| 自動再学習 | 雲海発生日データをもとにモデル更新（データ500〜1,000行規模になったら検証付きで自動化） |
| MLOps検証パイプライン | `train_model.py` に簡易検証ログを入れつつ、将来的に精度判定→自動デプロイまで拡張 |
| Web公開 | AWS／Render等で常時稼働化 |

---

## 11. 想定ユーザー・活用シーン

| 区分 | 想定利用者 | 活用例 |
|------|--------------|--------|
| 一般観光客 | 登城・撮影の事前確認 | 出現確率で早朝訪問判断 |
| カメラ愛好家 | 撮影日程計画 | 雲海＋朝日狙い日選定 |
| 観光協会 | 情報発信 | Web掲載・SNS投稿 |
| 教育機関 | STEM教材 | AI＋気象データ活用授業 |

---

## 12. ライセンス・利用条件

| 項目 | 内容 |
|------|------|
| API | Open-Meteo（無料・商用利用可） |
| 使用ライブラリ | LightGBM, Scikit-learn, Streamlit, OpenCV（すべて無料） |
| データ公開 | 出典を明記のうえ再利用可（Creative Commons BY-SA） |
| 著作権 | © 2025 SkyCastle AI Project |
| 再配布 | 教育・研究・自治体用途で自由利用可 |

---

## 13. ドキュメント管理情報

| 項目 | 内容 |
|------|------|
| 文書名 | SkyCastle AI 要件定義書（仕様書） |
| バージョン | v1.0 |
| 作成者 | SkyCastle Dev Team |
| 作成日 | 2025-10-29 |
| 監修 | ChatGPT（GPT-5） |
| 関連文書 | `docs/02_Technical_Design_SkyCastle.md`、`docs/03_Development_Guide_CodeX.md` |

---

📘 **本書は、開発および観光DX推進プロジェクトにおける公式仕様書として利用可能です。**
