# Fog Score / Castle Score やさしい解説

天空の城の「出現チャンス」を計算する 2 つのスコアについて説明します。コードは `score_fog.py` を参照してください。

## 1. まずは気温と湿度から「露点」を計算

- **露点（Td）** は「空気が冷えると水滴が付き始める温度」。
- 気温 `T` (℃) と湿度 `RH` (%) がわかれば、Magnus 式で求められます。

式：
```
α = ln(RH / 100) + (a * T) / (b + T)    （a = 17.625, b = 243.04）
Td = (b * α) / (a - α)
```

- 露点に近い気温だと蒸気が水滴になり、霧が出やすい＝雲海のチャンスが高い。
- ここで **露点差** `dew_spread = T - Td` を求めると、「どれくらい霧が出やすいか」の目安になります。

## 2. Fog Score（霧スコア）

100 点満点から減点していく仕組みです。霧が出やすい条件なら減点が少なく、高得点になります。

1. **露点差ペナルティ**：`12 × dew_spread` を最大 60 点まで引く。  
   - 露点差 5℃ なら 60 点引かれて 40 点残るイメージ。
2. **風速ペナルティ**：`max(wind - 1.5, 0) × 10` を最大 25 点まで引く。  
   - 風速 1.5 m/s を超えると霧が流されるので減点。
3. **降水量ペナルティ**：`rain × 5` を最大 10 点まで引く。  
   - 雨も霧を邪魔すると仮定。

最後に 0〜100 の範囲に収めて `fog_score` が完成。値が高いほど「濃い霧が出やすい」。

## 3. Castle Score（天空の城スコア）

`fog_score` をベースに、「雲の厚さ」や「露点差の余裕」を追加でチェックします。雲が多すぎたり少なすぎたりすると、城が浮かんで見えません。

1. **雲が少なすぎる** (`cloud < 40%`)：`(40 - cloud) × 0.6` を減点。晴れすぎて雲海にならない。
2. **雲が多すぎる** (`cloud > 90%`)：`(cloud - 90) × 0.8` を減点。雲が厚くて視界が悪い。
3. **露点差の再チェック**：`max(dew_spread - 2, 0) × 8` を最大 20 点まで減点。  
   - 露点差がさらに広がると雲海が切れやすい。

これも 0〜100 にクリップして `castle_score` が完成。  
**霧が出そう＋雲の量がちょうど良い** と高得点になります。

## 4. スコアのあとは何が起きる？

1. `score_fog.py` が Fog/Castle スコアと露点情報を `data/feed.json` に出力します。  
2. そのデータを `predict_model.py` が受け取り、機械学習モデルで **霧発生確率（fog_probability）** や **天空の城成立確率（castle_probability）** を計算します。ここで使っている LightGBM には `random_state=42` を渡しており、サイコロの出目（乱数の並び）を毎回同じに固定しています。同じ history.csv（現在は 263 行）を読み込んだときに “同じ条件なら同じ結果” を保証できるので、バグ調査や検証の再現性が保てます。行数が少ないうちは乱数によるブレが出やすいので、設定を変えず seed を固定したままにしておくのが安全です。データが大幅に増えたら seed の有無で差がほぼ出なくなりますが、現状は固定しておくメリットの方が大きいです。  
3. モデルはすでに学習済み（`model/skycastle_*.pkl`）で、過去の観測ログ `history.csv` を使って鍛えられています。予測時も history.csv の最新行から “前日との違い” などの追加特徴を作り、より賢く判断します。  
4. 得られた確率は `feed.json`／`history.csv` に記録され、ダッシュボードや 16 日予報 JSON (`predict_forecast_window.py`) を通じて `public/forecast.html` のカード表示に反映されます。

つまり **Fog/Castle スコアは AI 予測につながる最初のチェックポイント**。霧が出そうで雲の量がちょうどいい日は高スコアになり、それを受け取った AI が「じゃあ明日の霧チャンスは○％！」という最終判断をしてくれる仕組みです。

## 5. 確率はどうやって計算される？

Fog/Castle スコアを材料に、AI モデルが霧や天空の城の「確率」を出します。

1. `predict_model.py` が特徴量（気温・湿度・風・露点差・前日との比較など）をまとめて LightGBM に入力。
2. それぞれのモデルが勝手に判断を学習済みなので、  
   ```
   fog_probability    = fog_model.predict_proba(features)[1]
   castle_probability = castle_model.predict_proba(features)[1]
   ```
   のように 0〜1 の数値が返ってきます。
3. 「霧も出て城も浮かぶ」確率は、基本的に `fog_probability × castle_probability`（必要に応じてキャリブレーターで微調整）。
4. 0.5 以上なら `event = "Castle"`, 霧だけ 0.5 以上なら `"FogOnly"`, それ以外は `"None"` という判定で `public/forecast.html` のカードに反映されます。

イメージとしては「Fog/Castle スコア → 定期テストの点」「LightGBM → 過去の答案を全部覚えた先生」。点が高ければ先生（AI）が「じゃあ明日の城チャンスは80%だね！」と答えてくれる流れです。

## 6. まとめ

| 指標 | 何を表す？ | 高得点の条件 |
| ---- | ---------- | ------------ |
| Fog Score | 霧の濃さ（雲海の材料） | 露点差が小さい、風が弱い、雨が少ない |
| Castle Score | 「天空の城」らしく見えるか | Fog Score が高く、雲量が 40〜90% のちょうどいい範囲 |

### 将来的な拡張案（快晴＋谷霧パターンの学習）

- 現状の `history.csv` は 263 行で、雲量 20% 未満でも城が見えたケースが 40 件程度。このままでは LightGBM に “快晴だけど谷に霧が残る” レアパターンを十分学習させるのが難しい。  
- 将来的に行数が 500〜1,000 行、快晴＋谷霧のサンプルが 50 件前後まで増えたら、新しいフラグやモデルを追加してこのパターンを覚えさせることを検討する。  
- それまではルールベース（雲量や風速の補正値など）で微調整しつつ、写真ログや実測器で実例を集めることが優先。データがそろうタイミングで再学習フローへ組み込む。
- 同様に、検証結果でモデル採用の可否を自動判定したり、MLOps のように「再学習 → 自動デプロイ」までワンセットで回すのは、最低でも総データ 500〜1,000 行（検証用 100 行程度）を確保できてから。現状は `train_model.py` に簡易な検証ログを仕込み、手動で数値を確認しながらモデル更新する運用を続ける。

### 天空の城が出現しやすい気象条件

- **露点差が 2℃以下**（理想は 1℃前後）  
- **風速 1.5 m/s 以下**（ほぼ無風）  
- **雲量 40〜90%**（薄く広がる雲海がベスト）  
- **降水量ほぼゼロ**（雨が降ると霧が散る）  
- **湿度が90%前後で放射冷却が効く夜**（冷え込みで霧ができやすい）

#### わかりやすく解説
1. 露点差（気温と露点の差）が小さいほど水蒸気が水滴になりやすく、濃い霧＝雲海ができやすいです。目安は 2℃以下、理想は 1℃前後。score_fog.py では露点差が 5℃を超えると一気に減点されるので、2℃以内をキープできるかが第一条件。
2. 風速は 1.5 m/s 以下がベスト。これを超えると霧が流れてしまい、fog_score でも max(wind - 1.5, 0) × 10 で減点されています。ほぼ無風～そよ風くらいが理想。
3. 雲量は 40〜90% の中間ゾーンが “天空の城らしさ” には最適です。晴れすぎると雲海にならないし、雲が厚すぎると城が見えません。castle_score でも 40% 未満・90% 超で減点しています。
4. 降水量はほぼゼロが望ましく、1 mm を超える雨だと霧が散りやすいので fog_score が下がります。
5. 湿度は高め（90% 近い）だと露点差が縮まり、朝5〜8時の冷え込みで霧が発生しやすくなります。観測地点（犬山城址・標高324m）に冷たい空気がたまる放射冷却の夜が狙い目です。

まとめると、「前夜に放射冷却で冷え込み、湿度が高く、風がほぼ無く、雲が薄く広がる程度で、雨が降っていない」朝が、天空の城が雲海に浮かぶ好条件です。
これらの条件だと Fog/Castle スコアが高くなり、AI の最終確率でも「天空の城チャンス」が上がります。

これらのスコアを `score_fog.py` が計算し、結果を `data/feed.json` に保存します。その後の機械学習モデル（`predict_model.py` など）が Fog/Castle の確率を推論し、最終的に `public/forecast.html` でカード表示されます。
